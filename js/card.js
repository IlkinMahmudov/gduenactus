let originalData = [];

function renderProducts(products) {
  const list = document.getElementById('product-list');
  list.innerHTML = '';

  if (products.length === 0) {
    list.innerHTML = '<p>He√ß bir m…ôhsul tapƒ±lmadƒ±.</p>';
    return;
  }

  const params = new URLSearchParams(window.location.search);
  const category = params.get("category");

  console.log("üì¶ Cari category:", category);

  toggleBrandFilters(category);

  products.forEach(p => {
    const div = document.createElement('div');
    div.className = 'product-card';

    const discountTag = p.discount > 0 ? `<div class="discount-tag">-${p.discount}%</div>` : '';
    const oldPrice = p.discount > 0 && p.old_price !== null ? `<span class="old-price">${p.old_price} ‚Çº</span>` : ''; // old_price null ola bil…ôr

    div.innerHTML = `
      ${discountTag}
      <img src="${p.image}" alt="${p.name}">
      <div class="product-info">
        <div class="product-name">${p.name}</div>
        <div class="product-desc">${p.desc}</div>
        <div class="product-price">${p.price} ‚Çº ${oldPrice}</div>
        <div class="product-bottom">
          <span class="rating">‚≠ê ${p.rating} (${p.review_count})</span>
          <span>${p.location}</span>
        </div>
      </div>
    `;

    list.appendChild(div);
  });
}

function applyFilters() {
  const discountOnly = document.getElementById('discountOnly').checked;
  const min = parseFloat(document.getElementById('minPrice').value) || 0;
  const max = parseFloat(document.getElementById('maxPrice').value) || Infinity;
  const sortBy = document.getElementById('sortBy').value;

  const selectedBrands = Array.from(document.querySelectorAll('.brand-checkboxes input:checked')).map(cb => cb.value);

  let filtered = originalData.filter(p => {
    const inRange = p.price >= min && p.price <= max;
    const matchDiscount = !discountOnly || p.discount > 0;
    const matchBrand = selectedBrands.length === 0 || selectedBrands.includes(p.brand);
    return inRange && matchDiscount && matchBrand;
  });

  switch (sortBy) {
    case 'price-asc': filtered.sort((a, b) => a.price - b.price); break;
    case 'price-desc': filtered.sort((a, b) => b.price - a.price); break;
    case 'name-asc': filtered.sort((a, b) => a.name.localeCompare(b.name)); break;
    case 'name-desc': filtered.sort((a, b) => b.name.localeCompare(a.name)); break;
  }

  renderProducts(filtered);
}

function setupFilters() {
  const minInput = document.getElementById("minPrice");
  const maxInput = document.getElementById("maxPrice");
  const rangeMin = document.getElementById("priceRangeMin");
  const rangeMax = document.getElementById("priceRangeMax");

  // Number input il…ô slider sinxron
  minInput.addEventListener("input", () => {
    rangeMin.value = minInput.value;
    applyFilters();
  });

  maxInput.addEventListener("input", () => {
    rangeMax.value = maxInput.value;
    applyFilters();
  });

  // Slider input il…ô number input sinxron
  rangeMin.addEventListener("input", () => {
    minInput.value = rangeMin.value;
    applyFilters();
  });

  rangeMax.addEventListener("input", () => {
    maxInput.value = rangeMax.value;
    applyFilters();
  });

  document.getElementById('priceFilterBtn').addEventListener('click', applyFilters);
  document.getElementById('discountOnly').addEventListener('change', applyFilters);
  document.getElementById('sortBy').addEventListener('change', applyFilters);

  document.querySelectorAll('input[name="brand"]').forEach(cb => {
    cb.addEventListener('change', applyFilters);
  });
}

// ∆èlav…ô olunmu≈ü sinxron funksiya (t…ôhl√ºk…ôsiz saxlanƒ±b)
function syncPriceInputs() {
  const minInput = document.getElementById("minPrice");
  const maxInput = document.getElementById("maxPrice");
  const rangeMin = document.getElementById("priceRangeMin");
  const rangeMax = document.getElementById("priceRangeMax");

  rangeMin.value = minInput.value;
  rangeMax.value = maxInput.value;
}

function toggleBrandFilters(category) {
  const techFilter = document.getElementById('brand-filter');
  const bedFilter = document.getElementById('bed-brand-filter');
  const laptopFilter = document.getElementById('laptop-brand-filter');
  const powertoolsFilter = document.getElementById('powertools-brand-filter');
  const wardrobesFilter = document.getElementById('wardrobes-brand-filter');

  document.querySelectorAll('.brand-checkboxes').forEach(el => el.classList.add('hidden'));

  if (category === 'beds' || category === 'sofas') { // "furniture" …ôv…ôzin…ô "sofas" daxil etdim, √ß√ºnki …ôvv…ôlki JSON-da "sofas" var idi. ∆èg…ôr furniture olacaqsa …ôlav…ô ed…ô bil…ôrik.
    bedFilter.classList.remove('hidden');
  }
  else if(category === 'electronics' || category === 'blenders' || category === 'washing-machines' || category === 'microwaves' || category === 'refrigerators' || category === 'cameras' || category === 'drones'){
    laptopFilter.classList.remove('hidden'); // Elektronika kateqoriyalarƒ± √º√ß√ºn bir filter
  }
  else if(category === 'powertools'){
    powertoolsFilter.classList.remove('hidden');
  }
  else if(category === 'wardrobes'){
    wardrobesFilter.classList.remove('hidden');
  }
  else {
    techFilter.classList.remove('hidden'); // √úmumi texnologiya filtrl…ôri (…ôg…ôr h…ôl…ô d…ô istifad…ô olunursa)
  }
}


function setupSearch(category) {
  const input = document.getElementById("searchInput");
  const results = document.getElementById("searchResults");
  const searchButton = document.getElementById('searchButton'); // Axtar d√ºym…ôsini d…ô g√∂t√ºr…ôk

  fetch(`data/${category}.json`)
    .then(res => res.json())
    .then(data => {
      // originalData'nƒ± burada doldurmaq daha yax≈üƒ±dƒ±r, …ôg…ôr bu funksiya init zamanƒ± √ßaƒüƒ±rƒ±lƒ±rsa
      // originalData = data; // Bu s…ôtri INIT hiss…ôsind…ôn kopyaladƒ±m, iki d…ôf…ô √ßaƒüƒ±rƒ±lmasƒ±nƒ±n qar≈üƒ±sƒ±nƒ± almaq √º√ß√ºn

      // Sƒ∞Lƒ∞NDƒ∞: inputa m…ôtn yazdƒ±qca axtarƒ±≈ü funksiyasƒ±nƒ± i≈ü…ô salan hiss…ô
      /*
      input.addEventListener("input", () => {
        const val = input.value.trim().toLowerCase();
        if (!val) {
          results.style.display = "none";
          results.innerHTML = "";
          renderProducts(originalData);
          return;
        }

        const filtered = data.filter(p => p.name.toLowerCase().includes(val));
        results.innerHTML = filtered.length > 0 ?
          filtered.slice(0, 5).map((p, idx) => `
            <div class="search-result-item" data-index="${idx}">${p.name} - ${p.price} ‚Çº</div>
          `).join("") :
          "<div style='padding:10px;'>He√ß n…ô tapƒ±lmadƒ±</div>";

        results.style.display = "block";
        renderProducts(filtered);
      });
      */

      // YENƒ∞: Axtar d√ºym…ôsi klikl…ôndikd…ô axtarƒ±≈üƒ± et
      searchButton.addEventListener('click', () => {
        const val = input.value.trim().toLowerCase();
        if (!val) {
          results.style.display = "none";
          results.innerHTML = "";
          renderProducts(originalData); // Bo≈ü olarsa, b√ºt√ºn m…ôhsullarƒ± g√∂st…ôr
          return;
        }

        const filtered = data.filter(p => p.name.toLowerCase().includes(val));
        results.innerHTML = filtered.length > 0 ?
          filtered.slice(0, 5).map((p, idx) => `
            <div class="search-result-item" data-index="${idx}">${p.name} - ${p.price} ‚Çº</div>
          `).join("") :
          "<div style='padding:10px;'>He√ß n…ô tapƒ±lmadƒ±</div>";

        results.style.display = "block";
        renderProducts(filtered); // Filtrl…ônmi≈ü m…ôhsullarƒ± g√∂st…ôr
      });


      // Axtarƒ±≈ü n…ôtic…ôsin…ô klik ed…ônd…ô yalnƒ±z o m…ôhsulu g√∂st…ôr
      results.addEventListener("click", e => {
        if (e.target && e.target.classList.contains("search-result-item")) {
          const nameClicked = e.target.textContent.split(' - ')[0].trim().toLowerCase();
          const selected = data.find(p => p.name.toLowerCase() === nameClicked);
          if (selected) renderProducts([selected]);
          results.style.display = "none";
        }
      });

      // √ß√∂ld…ô klik olarsa, n…ôtic…ôl…ôri baƒüla
      document.addEventListener("click", e => {
        if (!results.contains(e.target) && e.target !== input && e.target !== searchButton) { // D√ºym…ôni d…ô …ôlav…ô etdik
          results.style.display = "none";
        }
      });

      // ESC il…ô axtarƒ±≈üƒ± t…ômizl…ô v…ô n…ôtic…ôl…ôri baƒüla
      input.addEventListener("keydown", e => {
        if (e.key === "Escape") {
          results.style.display = "none";
          input.value = "";
          renderProducts(originalData);
        } else if (e.key === "Enter") { // Enter basƒ±ldƒ±qda da axtarƒ±≈üƒ± i≈ü…ô salmaq √º√ß√ºn
          searchButton.click(); // Axtar d√ºym…ôsinin klik hadis…ôsini t…ôtikl…ô
        }
      });
    });
}

function setupCatalogMenu() {
  const categories = [
    { name: "blenders", label: "Blenderl…ôr", icon: "fa-solid fa-blender" },
    { name: "washing-machines", label: "Paltaryuyanlar", icon: "fa-solid fa-soap" },
    { name: "microwaves", label: "Mikrodalƒüalƒ± sobalar", icon: "fa-solid fa-fire-burner" },
    { name: "refrigerators", label: "Soyuducular", icon: "fa-solid fa-snowflake" },
    { name: "laptops", label: "Noutbuklar", icon: "fa-solid fa-laptop" },
    { name: "cameras", label: "Kameralar", icon: "fa-solid fa-camera" },
    { name: "sofas", label: "Divanlar", icon: "fa-solid fa-couch" },
    { name: "chairs", label: "Oturacaqlar", icon: "fa-solid fa-chair" },
    { name: "beds", label: "√áarpayƒ±lar", icon: "fa-solid fa-bed" },
    { name: "wardrobes", label: "Dolablar", icon: "fa-solid fa-warehouse" },
    { name: "powertools", label: "Elektrik al…ôtl…ôri", icon: "fa-solid fa-screwdriver-wrench" },
    { name: "electronics", label: "Elektronika", icon: "fa-solid fa-plug" },
    { name: "drones", label: "Dronlar", icon: "fa-solid fa-helicopter" }
  ];

  const container = document.querySelector(".catalog-menu");
  categories.forEach(cat => {
    const a = document.createElement("a");
    a.href = `card.html?category=${cat.name}&name=${cat.name}`;
    a.textContent = cat.label;
    container.appendChild(a);
  });
}

// INIT (S…ôhif…ô y√ºkl…ôn…ônd…ô ilkin i≈ü…ô salma)
const params = new URLSearchParams(window.location.search);
const category = params.get("category");
const name = params.get("name") || category;

if (category && name) {
  document.addEventListener("DOMContentLoaded", () => {
    toggleBrandFilters(category);
    setupFilters();
    setupSearch(name); // setupSearch-i √ßaƒüƒ±rƒ±rƒ±q
    setupCatalogMenu();

    fetch(`data/${name}.json`)
      .then(res => {
        if (!res.ok) throw new Error("404");
        return res.json();
      })
      .then(data => {
        originalData = data; // Original m…ôlumatlarƒ± burada saxlayƒ±rƒ±q
        renderProducts(data); // B√ºt√ºn m…ôhsullarƒ± ilk olaraq render edirik
      })
      .catch(err => {
        console.error("Fayl tapƒ±lmadƒ±:", err);
        document.getElementById("product-list").innerHTML = "<p style='padding:20px;'>M…ôhsul m…ôlumatƒ± tapƒ±lmadƒ±.</p>";
      });
  });
}

// T…ômizl…ôm…ô (X i≈üar…ôsi) funksionallƒ±ƒüƒ± artƒ±q yuxarƒ±dakƒ± `setupSearch` i√ßind…ô olmalƒ±dƒ±,
// ancaq DOMContentLoaded-in i√ßin…ô d…ô …ôlav…ô edildiyini n…ôz…ôr…ô alaraq onu da buraya da daxil etdim.
// Lakin …ôn optimalƒ±, bu event listenerl…ôrin yalnƒ±z bir yerd…ô olmasƒ±dƒ±r, tercihen setupSearch i√ßind…ô.
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('searchInput');
  const clearSearchIcon = document.getElementById('clearSearch');
  const searchButton = document.getElementById('searchButton');

  // Inputa m…ôtn daxil edildikd…ô "X" i≈üar…ôsini g√∂st…ôr
  // Bu hiss…ô h…ôl…ô d…ô h…ôr inputda i≈ül…ôy…ôc…ôk, lakin axtarƒ±≈ü n…ôtic…ôl…ôrini render etm…ôy…ôc…ôk.
  searchInput.addEventListener('input', () => {
    if (searchInput.value.length > 0) {
      clearSearchIcon.classList.remove('hidden');
    } else {
      clearSearchIcon.classList.add('hidden');
    }
  });

  // "X" i≈üar…ôsi klikl…ôndikd…ô inputu t…ômizl…ô v…ô "X"-i gizl…ô
  clearSearchIcon.addEventListener('click', () => {
    searchInput.value = '';
    clearSearchIcon.classList.add('hidden');
    searchInput.focus();
    renderProducts(originalData); // T…ômizl…ôy…ônd…ô b√ºt√ºn m…ôhsullarƒ± geri g…ôtir
    document.getElementById('searchResults').style.display = "none"; // Axtarƒ±≈ü n…ôtic…ôl…ôrini gizl…ôt
  });

  // Axtar d√ºym…ôsi klikl…ôndikd…ô n…ôtic…ôl…ôr √º√ß√ºn …ôlav…ô funksionallƒ±q
  // Qeyd: Bu event listener …ôg…ôr setupSearch i√ßind…ô d…ô varsa, iki d…ôf…ô i≈ül…ôy…ô bil…ôr.
  // setupSearch i√ßind…ôki …ôsas olaraq q…ôbul edilm…ôlidir.
  searchButton.addEventListener('click', () => {
    // setupSearch i√ßind…ôki axtarƒ±≈ü m…ôntiqi i≈ül…ôy…ôc…ôk
    console.log("Axtar d√ºym…ôsin…ô basƒ±ldƒ±.");
  });
});